var blog_title="天天的小站";class StaticBlog{constructor(){this.config={metaUrl:"data/meta.json",mdBasePath:"md/"},this.dom={nav:document.getElementById("nav"),postList:document.getElementById("postList"),postDetail:document.getElementById("postDetail"),articleTitle:document.getElementById("articleTitle"),articleContent:document.getElementById("articleContent"),backButton:document.getElementById("backButton"),copySuccess:document.getElementById("copySuccess"),articleCategory:document.getElementById("articleCategory"),articleCreated:document.getElementById("articleCreated"),articleTags:document.getElementById("articleTags"),loadingIndicator:document.getElementById("loading"),loadMoreButton:document.getElementById("loadMoreButton")},this.state={allPosts:[],filteredPosts:[],currentFilter:{type:"all",value:null},activeNavItem:null,pagination:{currentPage:1,totalPages:1,pageSize:10,isLoading:!1,hasMore:!0}},this.isMobile=window.innerWidth<=768}async init(){try{if(!window.MathJax){const t=document.createElement("script");t.src="./libs/mathjax/es5/tex-mml-chtml.js",t.async=!0,document.head.appendChild(t)}await this.loadInitialData(),this.initRouter(),this.initNavigation(),this.initEventListeners(),this.showPostList()}catch(t){this.showError("初始化失败: "+t.message)}}async loadInitialData(){const t=await fetch(this.config.metaUrl);if(!t.ok)throw new Error("元数据加载失败");const e=await t.json();this.state.pagination.totalPages=e.page_count,this.state.pagination.pageSize=e.page_size;for(let t=1;t<=e.page_count;t++){const e=await this.loadPage(t);e&&(this.state.allPosts=[...this.state.allPosts,...e.posts])}this.applyFilter()}async loadPage(t){if(this.state.pagination.isLoading)return null;this.state.pagination.isLoading=!0,this.toggleLoading(!0);try{const e=await fetch(`data/page_${t}.json`);if(!e.ok)throw new Error("分页加载失败");return await e.json()}finally{this.state.pagination.isLoading=!1,this.toggleLoading(!1)}}applyFilter(){const{type:t,value:e}=this.state.currentFilter;this.state.filteredPosts=this.state.allPosts.filter((s=>{switch(t){case"category":return s.category===e;case"tag":return s.tags?.includes(e);case"archive":return s.archive===e;default:return!0}}))}initRouter(){window.addEventListener("popstate",(()=>this.handleRouting())),this.handleRouting()}handleRouting(){const t=new URLSearchParams(location.search).get("path");if(t){this.dom.loadMoreButton.style.display="none";const e=this.state.allPosts.find((e=>e.path===decodeURIComponent(t)));e?this.showPostDetail(e):this.showNotFound()}else this.showPostList()}initEventListeners(){this.dom.nav.addEventListener("click",(t=>this.handleNavClick(t))),this.dom.backButton.addEventListener("click",(()=>this.showPostList())),window.addEventListener("scroll",(()=>this.handleScroll())),window.addEventListener("resize",(()=>this.handleResponsive()))}toggleLoading(t){this.dom.loadingIndicator.style.display=t?"flex":"none"}renderPostList(t){this.dom.postList.innerHTML=t.map((t=>`\n            <article class="post-item" data-path="${t.path}">\n                <h3>${t.title}</h3>\n                <div class="meta-info">\n                    <span class="category">${t.category}</span>\n                    <time>${t.created}</time>\n                    ${t.tags?.length?`\n                    <div class="tags">\n                        ${t.tags.map((t=>`<span class="tag">${t}</span>`)).join("")}\n                    </div>`:""}\n                </div>\n            </article>\n        `)).join(""),document.querySelectorAll(".post-item").forEach((t=>{t.addEventListener("click",(()=>{const e=this.state.allPosts.find((e=>e.path===t.dataset.path));this.showPostDetail(e)}))}))}postProcessContent(){hljs.highlightAll(),document.querySelectorAll("pre").forEach((t=>{const e=t.querySelector(".code-copy");e&&e.remove();const s=document.createElement("button");s.className="code-copy",s.textContent="复制",s.style.position="absolute",s.style.right="10px",s.style.top="10px",s.style.zIndex="10",s.style.background="rgba(255, 255, 255, 0.9)",s.style.border="1px solid #ddd",s.style.borderRadius="4px",s.style.padding="5px 10px",s.style.cursor="pointer",s.style.opacity="0",s.style.transition="opacity 0.3s ease",s.addEventListener("click",(()=>{const e=t.querySelector("code").innerText;this.copyToClipboard(e)})),t.appendChild(s),t.addEventListener("click",(t=>{t.stopPropagation(),s.style.opacity="1"})),t.addEventListener("scroll",(()=>{const{scrollTop:e,scrollLeft:a}=t;s.style.top=10-e+"px",s.style.right=10-a+"px"}))})),document.addEventListener("click",(()=>{document.querySelectorAll(".code-copy").forEach((t=>{t.style.opacity="0"}))}))}copyToClipboard(t){navigator.clipboard.writeText(t).then((()=>{this.showCopySuccess()})).catch((()=>{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this.showCopySuccess()}))}showCopySuccess(){this.dom.copySuccess.style.display="block",setTimeout((()=>{this.dom.copySuccess.style.display="none"}),2e3)}showPostList(){this.state.currentFilter={type:"all",value:null},history.replaceState(null,"",window.location.pathname),this.state.activeNavItem&&this.state.activeNavItem.classList.remove("active");const t=this.dom.nav.querySelector('[data-type="all"]');t&&(t.classList.add("active"),this.state.activeNavItem=t);const e=document.querySelector("head > title");e&&(e.textContent=`${blog_title}`),this.dom.postList.style.display="grid",this.dom.postDetail.style.display="none",this.renderView()}renderView(){const t=this.getFilteredPosts();this.renderPostList(t)}getFilteredPosts(){const{type:t,value:e}=this.state.currentFilter;return this.state.allPosts.filter((s=>{switch(t){case"category":return s.category===e;case"tag":return s.tags?.includes(e);case"archive":return s.archive===e;default:return!0}}))}initNavigation(){const t=[...new Set(this.state.allPosts.map((t=>t.category)))],e=[...new Set(this.state.allPosts.flatMap((t=>t.tags||[])))],s=[...new Set(this.state.allPosts.map((t=>t.archive)))];let a=`\n            <div class="nav-item active" data-type="all">全部</div>\n            ${this.createNavGroup("分类","category",t)}\n            ${this.createNavGroup("标签","tag",e)}\n            ${this.createNavGroup("归档","archive",s)}\n        `;this.dom.nav.innerHTML=a,this.state.activeNavItem=this.dom.nav.querySelector(".nav-item.active"),document.querySelectorAll(".nav-header").forEach((t=>{t.addEventListener("click",(e=>{const s=e.currentTarget.closest(".nav-group");if(window.innerWidth<=768)document.querySelectorAll(".nav-group").forEach((t=>{t!==s&&t.classList.remove("active")})),s.classList.toggle("active");else{const e=t.nextElementSibling;e.style.display="block"===e.style.display?"none":"block"}}))})),document.querySelectorAll(".nav-item").forEach((t=>{t.addEventListener("click",(t=>{this.handleNavClick(t)}))}))}createNavGroup(t,e,s){return s&&0!==s.length?`\n            <div class="nav-group">\n                <div class="nav-header">${t}</div>\n                <div class="nav-items">\n                    ${s.map((t=>`\n                        <div class="nav-item" data-type="${e}" data-value="${t}">${t}</div>\n                    `)).join("")}\n                </div>\n            </div>\n        `:""}handleNavClick(t){const e=t.target.closest(".nav-item");if(!e||!e.dataset.type)return;this.state.activeNavItem&&this.state.activeNavItem.classList.remove("active"),e.classList.add("active"),this.state.activeNavItem=e;const s=e.dataset.type,a=e.dataset.value;this.state.currentFilter="all"===s?{type:"all",value:null}:{type:s,value:a},this.renderView()}async showPostDetail(t){try{let e=t.content||await this.fetchContent(t.path);this.renderPost(t,e),history.pushState({},"",`?path=${encodeURIComponent(t.path)}`)}catch(t){this.showError("内容加载失败")}}async fetchContent(t){const e=await fetch(`${this.config.mdBasePath}${t}`);if(!e.ok)throw new Error("内容加载失败");return await e.text()}renderPost(t,e){const s=document.querySelector("head > title");if(s)s.textContent=`${t.title}-${blog_title}`;else{const e=document.createElement("title");e.textContent=`${t.title}-${blog_title}`,document.head.appendChild(e)}this.dom.articleTitle.textContent=t.title,this.dom.articleCategory.textContent=t.category,this.dom.articleCreated.textContent=t.created,this.dom.articleTags.innerHTML=t.tags?.map((t=>`<span class="tag">${t}</span>`)).join("")||"";const a=marked.parse(e),o=DOMPurify.sanitize(a,{ADD_TAGS:["iframe"],ADD_ATTR:["allowfullscreen","frameborder"]});this.dom.articleContent.innerHTML=o,window.MathJax?MathJax.typesetPromise().then((()=>{console.log("MathJax rendering complete.")})).catch((t=>{console.error("MathJax rendering failed:",t)})):console.warn("MathJax is not loaded. Please ensure MathJax is correctly included."),this.postProcessContent(),this.dom.postList.style.display="none",this.dom.postDetail.style.display="block",window.scrollTo({top:0,behavior:"smooth"})}postProcessContent(){hljs.highlightAll(),document.querySelectorAll("pre").forEach((t=>{const e=t.querySelector(".code-copy");e&&e.remove();const s=document.createElement("button");s.className="code-copy",s.textContent="复制",s.style.position="absolute",s.style.right="10px",s.style.top="10px",s.style.zIndex="10",s.style.background="rgba(255, 255, 255, 0.9)",s.style.border="1px solid #ddd",s.style.borderRadius="4px",s.style.padding="5px 10px",s.style.cursor="pointer",s.style.opacity="0",s.style.transition="opacity 0.3s ease",s.addEventListener("click",(()=>{const e=t.querySelector("code").innerText;this.copyToClipboard(e)})),t.appendChild(s),t.addEventListener("click",(t=>{t.stopPropagation(),s.style.opacity="1"})),t.addEventListener("scroll",(()=>{const{scrollTop:e,scrollLeft:a}=t;s.style.top=10-e+"px",s.style.right=10-a+"px"}))})),document.addEventListener("click",(()=>{document.querySelectorAll(".code-copy").forEach((t=>{t.style.opacity="0"}))}))}copyToClipboard(t){navigator.clipboard.writeText(t).then((()=>{this.showCopySuccess()})).catch((()=>{const e=document.createElement("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e),this.showCopySuccess()}))}showCopySuccess(){this.dom.copySuccess.style.display="block",setTimeout((()=>{this.dom.copySuccess.style.display="none"}),2e3)}showNotFound(){this.dom.articleContent.innerHTML='\n            <div class="not-found">\n                <h2>文章未找到</h2>\n                <p>请求的内容不存在或已被移除</p>\n                <button onclick="blog.showPostList()">返回列表</button>\n            </div>\n        ',this.dom.loadMoreButton.style.display="none"}showError(t){document.body.innerHTML=`\n            <div class="error">\n                <h2>系统错误</h2>\n                <p>${t}</p>\n                <button onclick="location.reload()">重新加载</button>\n            </div>\n        `}}const blog=new StaticBlog;document.addEventListener("DOMContentLoaded",(()=>blog.init()));